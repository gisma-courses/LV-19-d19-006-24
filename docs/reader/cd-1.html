<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Reudenbach">
<meta name="dcterms.date" content="2021-12-16">

<title>Advanced GIS and Remote Sensing - Change Detection - Klassifikationsverfahren</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: black;
      }

      .quarto-title-block .quarto-title-banner {
        color: black;
background-image: url(../reader/images/harz2-sp.jpg);
background-size: cover;
      }
</style>


<link rel="stylesheet" href="../css/styles.css">
<meta property="og:title" content="Advanced GIS and Remote Sensing - Change Detection - Klassifikationsverfahren">
<meta property="og:description" content="Clusteranalyse, Maximum-Likelihood and ML">
<meta property="og:site_name" content="Advanced GIS and Remote Sensing">
<meta name="twitter:title" content="Advanced GIS and Remote Sensing - Change Detection - Klassifikationsverfahren">
<meta name="twitter:description" content="Clusteranalyse, Maximum-Likelihood and ML">
<meta name="twitter:creator" content="@gisma">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logooil.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Advanced GIS and Remote Sensing</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../base/faq.html"> <i class="bi bi-question-square-fill" role="img">
</i> 
<span class="menu-text">FAQ</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://ilias3.uni-marburg.de/ilias.php?baseClass=ilrepositorygui&amp;cmdNode=zj:ne&amp;cmdClass=ilObjCourseGUI&amp;cmd=edit&amp;ref_id=4123762"> <i class="bi bi-chat-left-text-fill" role="img">
</i> 
<span class="menu-text">Ilias</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../reader/cd-1.html">Reader</a></li><li class="breadcrumb-item"><a href="../reader/cd-1.html">Classification Workflow</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../reader/cd-1.html">Reader</a></li><li class="breadcrumb-item"><a href="../reader/cd-1.html">Classification Workflow</a></li></ol></nav>
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Change Detection - Klassifikationsverfahren</h1>
            <p class="subtitle lead">Clusteranalyse, Maximum-Likelihood and ML</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Chris Reudenbach </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 16, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">GIS Basics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://gisma--courses-github-io.translate.goog/geoinfo-basis-qgis//unit01/unit01-01_reader_geo_raum.html?_x_tr_sl=de&amp;_x_tr_tl=en&amp;_x_tr_hl=de&amp;_x_tr_pto=wapp" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Space needs a scope</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://gisma--courses-github-io.translate.goog/geoinfo-basis-qgis//unit02/unit02-01_reader_gi_raum.html?_x_tr_sl=de&amp;_x_tr_tl=en&amp;_x_tr_hl=de&amp;_x_tr_pto=wapp" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Representation in GI</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">R-Spatial Basics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://gisma-courses.github.io/LV-19-d19-006/morea/geocomputation-with-r/reading-screencast-spatial-r-gis-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Some Pros &amp; Cons for R-Spatial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://thinking-spatial.org/courses/geoinformationen_kommunizieren/kurs1/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">First steps in geospatial R (German Ressource)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://r.geocompx.org/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geocomputation with R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Slides</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Pattern Description</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Landscape Patterns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Landscape Patterns Reloaded</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pattern-based spatial analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Continous data spatial analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Reader</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/cd-1.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Classification Workflow</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Worksheets</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/ws-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisies</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/ws-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Worksheet 1: Warm Up Exercises</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/ws-03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Worksheet 2: Landscape metrics part 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/ws-04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Worksheet 3: Landscape metrics part 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/ws-05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Worksheet 4: Pattern-based spatial analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/ws-06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Worksheet 5: Regionalisation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#information-from-image-data" id="toc-information-from-image-data" class="nav-link" data-scroll-target="#information-from-image-data">Information from image data</a></li>
  </ul></li>
  <li><a href="#classification-of-remote-sensing-data" id="toc-classification-of-remote-sensing-data" class="nav-link" data-scroll-target="#classification-of-remote-sensing-data">Classification of remote sensing data</a>
  <ul class="collapse">
  <li><a href="#supervised-classification" id="toc-supervised-classification" class="nav-link" data-scroll-target="#supervised-classification">Supervised classification</a></li>
  </ul></li>
  <li><a href="#change-detection-forest-change-northwest-harz" id="toc-change-detection-forest-change-northwest-harz" class="nav-link" data-scroll-target="#change-detection-forest-change-northwest-harz">Change Detection Forest Change Northwest Harz</a>
  <ul class="collapse">
  <li><a href="#start---setting-up-the-work-environment" id="toc-start---setting-up-the-work-environment" class="nav-link" data-scroll-target="#start---setting-up-the-work-environment">Start - Setting up the work environment</a></li>
  <li><a href="#step-1-get-an-overview" id="toc-step-1-get-an-overview" class="nav-link" data-scroll-target="#step-1-get-an-overview">Step 1: Get an overview</a></li>
  <li><a href="#download" id="toc-download" class="nav-link" data-scroll-target="#download">Download</a>
  <ul class="collapse">
  <li><a href="#preparation-of-the-data" id="toc-preparation-of-the-data" class="nav-link" data-scroll-target="#preparation-of-the-data">Preparation of the data</a></li>
  <li><a href="#first-impression-k-means-cluster-classification" id="toc-first-impression-k-means-cluster-classification" class="nav-link" data-scroll-target="#first-impression-k-means-cluster-classification">First impression – K-means cluster classification</a></li>
  </ul></li>
  <li><a href="#step-2---generating-training-data" id="toc-step-2---generating-training-data" class="nav-link" data-scroll-target="#step-2---generating-training-data">Step 2 - Generating training data</a></li>
  <li><a href="#digitizing-training-data" id="toc-digitizing-training-data" class="nav-link" data-scroll-target="#digitizing-training-data">Digitizing training data</a></li>
  <li><a href="#excursus-creating-training-areas-with-mapedit" id="toc-excursus-creating-training-areas-with-mapedit" class="nav-link" data-scroll-target="#excursus-creating-training-areas-with-mapedit">Excursus: Creating training areas with mapedit</a>
  <ul class="collapse">
  <li><a href="#using-color-composites-for-better-training-results" id="toc-using-color-composites-for-better-training-results" class="nav-link" data-scroll-target="#using-color-composites-for-better-training-results">Using color composites for better training results</a></li>
  </ul></li>
  <li><a href="#step-3---model-training-testing-model-quality-classification" id="toc-step-3---model-training-testing-model-quality-classification" class="nav-link" data-scroll-target="#step-3---model-training-testing-model-quality-classification">Step 3 - Model training, testing model quality, classification</a>
  <ul class="collapse">
  <li><a href="#maximum-likelihood-classification" id="toc-maximum-likelihood-classification" class="nav-link" data-scroll-target="#maximum-likelihood-classification">Maximum Likelihood Classification</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random forest</a></li>
  <li><a href="#estimation-model-quality" id="toc-estimation-model-quality" class="nav-link" data-scroll-target="#estimation-model-quality">Estimation model quality</a></li>
  <li><a href="#prediction-on-the-original-data" id="toc-prediction-on-the-original-data" class="nav-link" data-scroll-target="#prediction-on-the-original-data">Prediction on the original data</a></li>
  </ul></li>
  <li><a href="#further-support" id="toc-further-support" class="nav-link" data-scroll-target="#further-support">Further support</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/gisma-courses/LV-19-d19-006-24/edit/main/reader/cd-1.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/gisma-courses/LV-19-d19-006-24/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In the geosciences, remote sensing is the only measurement technique that allows complete coverage of large spatial areas, up to the entire Earth’s surface. Its successful application requires both the use of existing methods and the adaptation and development of new ones.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In geospatial or environmental informatics, the detection of changes to the Earth’s surface using satellite, aircraft or drone images, known as change detection analysis, is an important application. These results are often linked to biophysical, geophysical or anthropogenic processes in order to gain both a deeper understanding and the possibility of developing predictive models. Methods of image analysis are of outstanding importance for generating spatial information from the underlying processes. Since both the quantity and quality of this “image data” are playing an increasingly important role in environmental monitoring and modeling, it is becoming more and more necessary to integrate “big data” concepts into the analyses. This means performing reproducible analyses with large amounts of data (&gt;&gt; 10 GB). This is essential for both scientific knowledge gain and future societal challenges.</p>
<p>As already explained in the introduction, we start with a scalable change detection analysis of forest damage in low mountain ranges, which is a typical application-oriented task. Scalable means that we limit the analysis to a manageable area, the Nordwestharz, and to two time slices. However, the resulting algorithm can be applied to different or larger areas and to more time slices.</p>
<section id="information-from-image-data" class="level2">
<h2 class="anchored" data-anchor-id="information-from-image-data">Information from image data</h2>
<p>Unprocessed satellite images are not necessarily informative. While our eyes can interpret a true-color image relatively conclusively and intuitively, a reliable and reproducible, i.e.&nbsp;scientifically sound, interpretation requires other approaches. A major advantage of typical image analysis methods over visual interpretation is the derivation of additional, so-called <em>invisible</em> information. We have already calculated simple indices such as NDVI or surface albedo as a physically based conversion of image signals into a measured variable.</p>
<p>To obtain useful or meaningful information, e.g.&nbsp;about the land cover in an area, we have to analyze the data according to the question at hand. Probably the best known and most widely used approach is the supervised classification of image data into categories of interest.</p>
<p>This tutorial introduces you to the classification of satellite and aerial image data.</p>
<p>We will cover the following topics:</p>
<ol type="1">
<li>preparation of the working environment and loading of data</li>
<li>digitization of the training areas</li>
<li>unsupervised classification (kmeans clustering)</li>
<li>model training</li>
<li>supervised classification (Random Forest, Maximum Likelihood)</li>
<li>estimation of model quality</li>
</ol>
</section>
</section>
<section id="classification-of-remote-sensing-data" class="level1">
<h1>Classification of remote sensing data</h1>
<p>Please note that all types of classification usually require extensive data pre-processing. The focus is then on model building and quality assessment, which can be seen as the technical basis for classification, in order to finally derive the interpretation of the results in terms of content in the data post-processing. We will go through this process step by step.</p>
<section id="supervised-classification" class="level2">
<h2 class="anchored" data-anchor-id="supervised-classification">Supervised classification</h2>
<p>In supervised land cover classification, a model is derived from a limited amount of training land cover data that predicts land cover for the entire data set. The land cover types are defined <em>a priori</em>, and the model attempts to predict these types based on the similarity between the characteristics of the training data and the rest of the data set.</p>
<p><img src="images/supervised_classification.jpg" class="img-fluid"></p>
<p>From a pragmatic point of view, classification tasks generally require the following steps:</p>
<ul>
<li>Creation of a comprehensive input data set that contains one or more raster layers. Selection of training areas, i.e.&nbsp;subsets of the input data set for which the land cover type is known to the remote sensing expert. Knowledge of the land cover can be obtained, for example, from one’s own or third-party in situ observations, management information or other remote sensing products (e.g.&nbsp;high-resolution aerial photographs). Training a model using the training sites. For validation purposes, the training sites are often subdivided into one or more test and training sites to evaluate the performance of the model algorithm. Applying the trained model to the entire data set, i.e.&nbsp;predicting the land cover type based on the similarity of the data at each site to the class characteristics of the training data set.</li>
</ul>
</section>
</section>
<section id="change-detection-forest-change-northwest-harz" class="level1">
<h1>Change Detection Forest Change Northwest Harz</h1>
<p>In this tutorial, we will use the Sentinel-2 images from the previous exercise.</p>
<section id="start---setting-up-the-work-environment" class="level2">
<h2 class="anchored" data-anchor-id="start---setting-up-the-work-environment">Start - Setting up the work environment</h2>
<p>You can either use the data saved from the previous exercise or define, download and edit a new area. However, the work environment is usually loaded first.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- 0 Projekt Setup ----</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># packages installing if necessary and loading</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(mapview, mapedit, tmap, tmaptools, raster, terra, stars, gdalcubes, sf, dplyr,CDSE, downloader, tidyverse,RStoolbox,rprojroot, exactextractr, randomForest, ranger, e1071, caret, link2GI, rstac, OpenStreetMap,colorspace)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#--- Switch to determine whether digitization is required. If set to FALSE, the</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>root_folder <span class="ot">=</span> <span class="fu">find_rstudio_root_file</span>()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>ndvi.col <span class="ot">=</span> <span class="cf">function</span>(n) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rev</span>(<span class="fu">sequential_hcl</span>(n, <span class="st">"Green-Yellow"</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>ano.col <span class="ot">=</span> <span class="fu">diverging_hcl</span>(<span class="dv">7</span>, <span class="at">palette =</span> <span class="st">"Red-Green"</span>,  <span class="at">register =</span> <span class="st">"rg"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>nclasses<span class="ot">=</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Please add any missing or defective packages in the above setup script (if error messages occur). On the basis of the available Sentinel data, the first step should be to identify suitable data sets for a surface classification.</p>
</section>
<section id="step-1-get-an-overview" class="level2">
<h2 class="anchored" data-anchor-id="step-1-get-an-overview">Step 1: Get an overview</h2>
<p>A closer look at the RGB images (RGB432B) shows that four data sets appear to be suitable due to the image quality and low cloud cover. These are June 19 and July 24, 2019, and June 33 and July 30, 2020. The May images were chosen because of the earlier growing season, as any growth on the cleared areas might be less visible here.</p>
<p>First of all, this data must be available in a “raster stack”, i.e.&nbsp;a multi-channel image.</p>
</section>
<section id="download" class="level2">
<h2 class="anchored" data-anchor-id="download">Download</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">####</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="at">url=</span><span class="st">"https://github.com/gisma/gismaData/raw/master/MOF/MOF_CORE.gpkg"</span>,<span class="at">destfile=</span><span class="st">"../data/MOF_CORE.gpkg"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>forest_mask <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"../data/MOF_CORE.gpkg"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_crs</span>(forest_mask) <span class="ot">&lt;-</span> <span class="dv">4326</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>fm<span class="ot">=</span><span class="fu">bb</span>(forest_mask,<span class="at">projection=</span><span class="dv">4326</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># forest_4326 =st_transform(forest_mask,crs = 4326)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># forest_3035 =st_transform(forest_mask,crs = 3035)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># forest_32632 =st_transform(forest_mask,crs = 32632)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># mapping the extents and boundaries of the choosen geometries</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"view"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_options</span>(<span class="at">check.and.fix =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_basemap</span>(<span class="at">server =</span> <span class="fu">c</span>(<span class="st">"Esri.WorldImagery"</span>, <span class="st">"Esri.WorldTopoMap"</span>)) <span class="sc">+</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(forest_mask) <span class="sc">+</span>   </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">col=</span><span class="st">"mainTreeSp"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>id <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"CDSE_ID"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>secret <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"CDSE_SECRET"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>OAuthClient <span class="ot">&lt;-</span> <span class="fu">GetOAuthClient</span>(<span class="at">id =</span> id, <span class="at">secret =</span> secret)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>collections <span class="ot">&lt;-</span> <span class="fu">GetCollections</span>(<span class="at">as_data_frame =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>collections</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> <span class="fu">SearchCatalog</span>(<span class="at">bbox =</span>cm, <span class="at">from =</span> <span class="st">"2018-05-01"</span>, <span class="at">to =</span> <span class="st">"2021-05-31"</span>, </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>, <span class="at">with_geometry =</span> <span class="cn">TRUE</span>, <span class="at">client =</span> OAuthClient)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>images</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(images<span class="sc">$</span>areaCoverage)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>day <span class="ot">&lt;-</span> images[<span class="fu">order</span>(images<span class="sc">$</span>tileCloudCover), ]<span class="sc">$</span>acquisitionDate[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>]</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>script_file_rb <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"scripts"</span>, <span class="st">"RawBands.js"</span>, <span class="at">package =</span> <span class="st">"CDSE"</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>script_file_ndvi <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"scripts"</span>, <span class="st">"NDVI_float32.js"</span>, <span class="at">package =</span> <span class="st">"CDSE"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>script_file_tc <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"scripts"</span>, <span class="st">"TrueColor.js"</span>, <span class="at">package =</span> <span class="st">"CDSE"</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>r_rb <span class="ot">&lt;-</span> <span class="fu">GetImage</span>(<span class="at">bbox =</span>  ext, <span class="at">time_range =</span> day[<span class="dv">5</span>], <span class="at">script =</span> script_file_rb, </span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>                <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>, <span class="at">format =</span> <span class="st">"image/tiff"</span>, <span class="at">mosaicking_order =</span> <span class="st">"leastCC"</span>, </span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>                <span class="at">resolution =</span> <span class="dv">10</span>, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">buffer =</span> <span class="dv">100</span>, <span class="at">client =</span> OAuthClient)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_rb) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"B01"</span>, <span class="st">"B02"</span>, <span class="st">"B03"</span>, <span class="st">"B04"</span>, <span class="st">"B05"</span>, <span class="st">"B06"</span>, <span class="st">"B07"</span>, <span class="st">"B08"</span>, <span class="st">"B8A"</span>, <span class="st">"B09"</span>, <span class="st">"B11"</span>, <span class="st">"B12"</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(r_rb, <span class="at">main =</span> <span class="fu">paste</span>(<span class="fu">names</span>(r_rb), day), <span class="at">cex.main =</span> <span class="fl">0.75</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>r_ndvi <span class="ot">&lt;-</span> <span class="fu">GetImage</span>(<span class="at">bbox =</span>  fm, <span class="at">time_range =</span> day[<span class="dv">5</span>], <span class="at">script =</span> script_file_ndvi, </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>, <span class="at">format =</span> <span class="st">"image/tiff"</span>, <span class="at">mosaicking_order =</span> <span class="st">"leastCC"</span>, </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                <span class="at">resolution =</span> <span class="dv">10</span>, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">buffer =</span> <span class="dv">100</span>, <span class="at">client =</span> OAuthClient)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_ndvi) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NDVI"</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(r_ndvi, <span class="at">main =</span> <span class="fu">paste</span>(<span class="fu">names</span>(r_ndvi), day), <span class="at">cex.main =</span> <span class="fl">0.75</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>r_tc <span class="ot">&lt;-</span> <span class="fu">GetImage</span>(<span class="at">bbox =</span>  fm, <span class="at">time_range =</span> day[<span class="dv">5</span>], <span class="at">script =</span> script_file_tc, </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>, <span class="at">format =</span> <span class="st">"image/tiff"</span>, <span class="at">mosaicking_order =</span> <span class="st">"leastCC"</span>, </span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>                <span class="at">resolution =</span> <span class="dv">10</span>, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">buffer =</span> <span class="dv">100</span>, <span class="at">client =</span> OAuthClient)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_tc) <span class="ot">=</span> <span class="fu">c</span>( <span class="st">"B02"</span>, <span class="st">"B03"</span>, <span class="st">"B04"</span>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(r_tc, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"true color B02, B03, B04"</span>), <span class="at">cex.main =</span> <span class="fl">0.75</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> <span class="fu">SearchCatalog</span>(<span class="at">bbox =</span> fm, <span class="at">from =</span> <span class="st">"2018-01-01"</span>, <span class="at">to =</span> <span class="st">"2023-12-31"</span>,</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>                        <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>, <span class="at">with_geometry =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>                        <span class="at">filter =</span> <span class="st">"eo:cloud_cover &lt; 5"</span>, <span class="at">client =</span> OAuthClient)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> <span class="fu">SearchCatalog</span>(<span class="at">aoi =</span> forest_mask, <span class="at">from =</span> <span class="st">"2018-01-01"</span>, <span class="at">to =</span> <span class="st">"2023-12-31"</span>,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>                        <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>, <span class="at">with_geometry =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>                        <span class="at">filter =</span> <span class="st">"eo:cloud_cover &lt; 10"</span>, <span class="at">client =</span> OAuthClient)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the day with the minimal cloud cover for every month -----------------------------</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>tmp1 <span class="ot">&lt;-</span> images[, <span class="fu">c</span>(<span class="st">"tileCloudCover"</span>, <span class="st">"acquisitionDate"</span>)]</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>tmp1<span class="sc">$</span>month <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">month</span>(images<span class="sc">$</span>acquisitionDate)</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>agg1 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">aggregate</span>(tileCloudCover <span class="sc">~</span> month, <span class="at">data =</span> tmp1, <span class="at">FUN =</span> min)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>tmp2 <span class="ot">&lt;-</span> <span class="fu">merge.data.frame</span>(agg1, tmp1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"tileCloudCover"</span>), <span class="at">sort =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a><span class="co"># in case of ties, get an arbitrary date (here the smallest acquisitionDate, </span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co"># could also be the biggest)</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>agg2 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">aggregate</span>(acquisitionDate <span class="sc">~</span> month, <span class="at">data =</span> tmp2, <span class="at">FUN =</span> min)</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>monthly <span class="ot">&lt;-</span> <span class="fu">merge.data.frame</span>(agg2, tmp2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"acquisitionDate"</span>, <span class="st">"month"</span>), <span class="at">sort =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>days <span class="ot">&lt;-</span> monthly<span class="sc">$</span>acquisitionDate</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve images in parallel ----------------------------------------------------------</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>script_file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"scripts"</span>, <span class="st">"NDVI_float32.js"</span>, <span class="at">package =</span> <span class="st">"CDSE"</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>tmp_folder <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="st">"dir"</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>lstRast <span class="ot">&lt;-</span> <span class="fu">lapply</span>(days, GetImageByTimerange, <span class="at">bbox =</span> fm, <span class="at">collection =</span> <span class="st">"sentinel-2-l2a"</span>,</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">script =</span> script_file, <span class="at">file =</span> <span class="cn">NULL</span>, <span class="at">format =</span> <span class="st">"image/tiff"</span>, <span class="at">mosaicking_order =</span> <span class="st">"mostRecent"</span>,</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">resolution =</span> <span class="dv">10</span>, <span class="at">buffer =</span> <span class="dv">0</span>, <span class="at">mask =</span> <span class="cn">TRUE</span>, <span class="at">client =</span> OAuthClient,</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">getOption</span>(<span class="st">"CDSE.process_url"</span>))</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the images ----------------------------------------------------------------------</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="fu">seq_along</span>(days), <span class="at">FUN =</span> <span class="cf">function</span>(i) {</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>     ras <span class="ot">&lt;-</span> lstRast[[i]]</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>     day <span class="ot">&lt;-</span> days[i]</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>     <span class="co">#ras[ras &lt; 0] &lt;- 0</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>     terra<span class="sc">::</span><span class="fu">plot</span>(ras, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"MOF NDVI on"</span>, day), <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>            <span class="at">cex.main =</span> <span class="fl">0.7</span>, <span class="at">pax =</span> <span class="fu">list</span>(<span class="at">cex.axis =</span> <span class="fl">0.5</span>), <span class="at">plg =</span> <span class="fu">list</span>(<span class="at">cex =</span> <span class="fl">0.5</span>),</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"darkred"</span>, <span class="st">"yellow"</span>, <span class="st">"darkgreen"</span>))(<span class="dv">99</span>))</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>     })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="preparation-of-the-data" class="level3">
<h3 class="anchored" data-anchor-id="preparation-of-the-data">Preparation of the data</h3>
<p>As soon as the download has been successful, the actual classification can begin. First, the data must be organized in a technically suitable way as a multichannel image. In addition, a current or temporally corresponding Corine land use data set is loaded to generate a binary forest/non-forest mask. The already available Copernicus account can be used to download the Corine data (https://land.copernicus.eu/pan-european/corine-land-cover). After the (manual) download, unzip the data into the subdirectory ‘level0’ (be careful, there are countless subdirectories here after unzipping the archive). We need the file <code>U2018_CLC2018_V2020_20u1.tif</code>. Alternatively, the already correctly processed and projected *data set from the github repository (see script) can be used.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- Reading the data from the directories</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="do">##--- This describes how to process the Corine land use and land cover dataset</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">## The necessary file can also be downloaded from the repository</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="do">## An account is required for the download https://land.copernicus.eu/pan-european/corine-land-cover</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Therefore, download the data manually and copy it into the directory and unzip it</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Then execute the commented snippet below</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># corine_eu = raster(file.path(envrmt$path_data_lev0,"u2018_clc2018_v2020_20u1_raster100m/DATA/U2018_CLC2018_V2020_20u1.tif"))</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># tmp = projectRaster(pred_stack_2019[[1]],crs = crs(corine_eu))</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># corine_crop = raster::crop(corine_eu,tmp)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># corine_utm = projectRaster(corine_crop,crs = crs(pred_stack_2019))</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># corine = resample(corine_utm,pred_stack_2019[[1]])</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># raster::writeRaster(corine,file.path(envrmt$path_data_lev0,"/corine.tif"),overwrite=TRUE)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively, download the example data set</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="at">url=</span><span class="st">"https://github.com/gisma/gismaData/raw/master/geoinfo/corine.tif"</span>,<span class="at">destfile=</span><span class="fu">file.path</span>(root_folder,<span class="st">"data/corine.tif"</span>))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>corine <span class="ot">=</span> <span class="fu">rast</span>(<span class="fu">file.path</span>(root_folder,<span class="st">"data/corine.tif"</span>))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(corine)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a forest mask</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Agro-forestry areas code=22, Broad-leaved forest code=23,</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Coniferous forest code=24, Mixed forest code=25</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">=</span> <span class="fu">classify</span>(corine,<span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>,<span class="dv">22</span>,<span class="dv">0</span>,<span class="dv">22</span>,<span class="dv">26</span>,<span class="dv">1</span>,<span class="dv">26</span>,<span class="dv">500</span>,<span class="dv">0</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mask)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co"># RGB stack of the two years</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="at">url=</span><span class="st">"https://github.com/gisma/gismaData/raw/master/geoinfo/corine.tif"</span>,<span class="at">destfile=</span><span class="fu">file.path</span>(root_folder,<span class="st">"data/corine.tif"</span>))</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="at">url=</span><span class="st">"https://github.com/gisma/gismaData/raw/master/geoinfo/corine.tif"</span>,<span class="at">destfile=</span><span class="fu">file.path</span>(root_folder,<span class="st">"data/corine.tif"</span>))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>pred_stack_2019 <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">stack</span>(<span class="fu">list.files</span>(<span class="fu">file.path</span>(envrmt<span class="sc">$</span>path_data_lev1,<span class="st">"BOA"</span>),<span class="at">pattern =</span> <span class="st">"20190619"</span>,<span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>pred_stack_2020 <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">stack</span>(<span class="fu">list.files</span>(<span class="fu">file.path</span>(envrmt<span class="sc">$</span>path_data_lev1,<span class="st">"BOA"</span>),<span class="at">pattern =</span> <span class="st">"20200623"</span>,<span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack loop over the data</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (pat <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"EVI"</span>, <span class="st">"MSAVI2"</span>, <span class="st">"NDVI"</span>, <span class="st">"SAVI"</span>)){</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>pred_stack_2019 <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">stack</span>(pred_stack_2019, <span class="fu">stack</span>(<span class="fu">list.files</span>(<span class="fu">file.path</span>(envrmt<span class="sc">$</span>path_data_lev1, pat), <span class="at">pattern =</span> <span class="st">"20190619"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>pred_stack_2020 <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">stack</span>(pred_stack_2020,<span class="fu">stack</span>(<span class="fu">list.files</span>(<span class="fu">file.path</span>(envrmt<span class="sc">$</span>path_data_lev1,pat),<span class="at">pattern =</span> <span class="st">"20200623"</span>,<span class="at">full.names =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co"># get rid of NA</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>pred_stack_2019 <span class="ot">=</span> <span class="fu">reclassify</span>(pred_stack_2019, <span class="fu">cbind</span>(<span class="cn">NA</span>, <span class="dv">0</span>))</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>pred_stack_2020 <span class="ot">=</span> <span class="fu">reclassify</span>(pred_stack_2020, <span class="fu">cbind</span>(<span class="cn">NA</span>, <span class="dv">0</span>))</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign human-readable names to the data layers</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pred_stack_2019) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"band1"</span>, <span class="st">"band2"</span>, <span class="st">"band3"</span>, <span class="st">"band4"</span>, <span class="st">"band5"</span>, <span class="st">"band6"</span>, <span class="st">"band7"</span>, <span class="st">"band8"</span>, <span class="st">"band9"</span>, <span class="st">"band10"</span>, <span class="st">"band11"</span>, <span class="st">"EVI"</span>, <span class="st">"MSAVI2"</span>, <span class="st">"NDVI"</span>, <span class="st">"SAVI"</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pred_stack_2020) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"band1"</span>, <span class="st">"band2"</span>, <span class="st">"band3"</span>, <span class="st">"band4"</span>, <span class="st">"band5"</span>, <span class="st">"band6"</span>, <span class="st">"band7"</span>, <span class="st">"band8"</span>, <span class="st">"band9"</span>, <span class="st">"band10"</span>, <span class="st">"band11"</span>, <span class="st">"EVI"</span>, <span class="st">"MSAVI2"</span>, <span class="st">"NDVI"</span>, <span class="st">"SAVI"</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(pred_stack_2019,<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"pred_stack_2019.rds"</span>))</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(pred_stack_2020,<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"pred_stack_2020.rds"</span>))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>pred_stack_2019 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"pred_stack_2019.rds"</span>))</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>pred_stack_2020 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"pred_stack_2020.rds"</span>))</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co"># visual inspection of the stacks</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_stack_2019)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_stack_2020)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="first-impression-k-means-cluster-classification" class="level3">
<h3 class="anchored" data-anchor-id="first-impression-k-means-cluster-classification">First impression – K-means cluster classification</h3>
<p>Probably the best-known unsupervised classification technique is K-means clustering, which is also referred to as the <em>“simplest machine learning algorithm”</em>. It is often used to obtain an initial overview of whether the raster data can be sufficiently separated in feature space.</p>
<p>In our example (applied to 5 classes and executed with the function <code>unsuperClass</code> from the <code>RStoolbox</code> package), this looks as follows. The cluster algorithm can achieve a fairly acceptable separation of the clearings/bald spots with 5 clusters, which makes a classification seem promising. Also experiment with other cluster settings and discuss the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## k-means über RStoolbox</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modell</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>prediction_kmeans_2019 <span class="ot">=</span> RStoolbox<span class="sc">::</span><span class="fu">unsuperClass</span>(pred_stack_2019, <span class="at">nClasses =</span> <span class="dv">5</span>,<span class="at">norm =</span> <span class="cn">TRUE</span>, <span class="at">algorithm =</span> <span class="st">"MacQueen"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Klassifikation</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prediction_kmeans_2019<span class="sc">$</span>map)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>prediction_kmeans_2020 <span class="ot">=</span> RStoolbox<span class="sc">::</span><span class="fu">unsuperClass</span>(pred_stack_2020, <span class="at">nClasses =</span> <span class="dv">5</span>,<span class="at">norm =</span> <span class="cn">TRUE</span>, <span class="at">algorithm =</span> <span class="st">"MacQueen"</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prediction_kmeans_2020<span class="sc">$</span>map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/kmeans-2020.png" class="img-fluid"> <img src="images/kmeans-2019.png" class="img-fluid"></p>
</section>
</section>
<section id="step-2---generating-training-data" class="level2">
<h2 class="anchored" data-anchor-id="step-2---generating-training-data">Step 2 - Generating training data</h2>
<p>For a supervised classification, we need data that indicates which surface class defined areas of the satellite image belong to. This data is referred to as training data and is very often obtained by manual digitization. This can be done quite comfortably in RStudio if only a few training areas have to be digitized quickly and effectively.</p>
<p>For larger tasks, it makes sense to use the convenient method described in the QGIS 3.16 documentation, for example in the <a href="https://docs.qgis.org/3.16/en/docs/training_manual/create_vector_data/create_new_vector.html#basic-ty-digitizing-polygons">digitizing tutorial</a>.</p>
</section>
<section id="digitizing-training-data" class="level2">
<h2 class="anchored" data-anchor-id="digitizing-training-data">Digitizing training data</h2>
<p>We assume that we want to classify two types of land cover: <em>clearcut</em> and <em>other</em>. With mapedit, each class must be digitized individually. Once the training areas are available as vector data, the features of the respective raster stack can be extracted into a table according to the digitized classes and corrected for possible missing values.</p>
<p>If this part has already been completed, the logical variable <em>digitize</em> (defined at the beginning of the script) can be set to <em>FALSE</em> and the <em>else</em> part of the branch can be run – in other words, only the existing data is read.</p>
</section>
<section id="excursus-creating-training-areas-with-mapedit" class="level2">
<h2 class="anchored" data-anchor-id="excursus-creating-training-areas-with-mapedit">Excursus: Creating training areas with mapedit</h2>
<section id="using-color-composites-for-better-training-results" class="level3">
<h3 class="anchored" data-anchor-id="using-color-composites-for-better-training-results">Using color composites for better training results</h3>
<p>For this exercise, we use <code>mapedit</code>, a small but powerful package that allows you to digitize and edit vector data in Rstudio or an external browser. In combination with <code>mapview</code>, any [color composite] (https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel-2/composites/) can also be used as a basis for digitization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">=</span> <span class="fu">tm_shape</span>(pred_stack_2019) <span class="sc">+</span> <span class="fu">tm_rgb</span>(<span class="at">r=</span><span class="dv">4</span>, <span class="at">g=</span><span class="dv">3</span>, <span class="at">b=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside.position =</span> <span class="st">"right"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside =</span> T,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.label.height=</span><span class="fl">0.6</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.label.size=</span><span class="fl">0.6</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.labels =</span> <span class="fu">c</span>(<span class="st">"r=1, g=2, b=3"</span>)) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_grid</span>()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">=</span> <span class="fu">tm_shape</span>(pred_stack_2019) <span class="sc">+</span> <span class="fu">tm_rgb</span>(<span class="at">r=</span><span class="dv">8</span>, <span class="at">g=</span><span class="dv">4</span>, <span class="at">b=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside.position =</span> <span class="st">"right"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside =</span> T,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.label.height=</span><span class="fl">0.6</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.label.size=</span><span class="fl">0.6</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.labels =</span> <span class="fu">c</span>(<span class="st">"r=8, g=4, b=3"</span>)) <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_grid</span>()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>tmap<span class="sc">::</span><span class="fu">tmap_arrange</span>(m1,m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/rgb.png" class="img-fluid"></p>
<p>The planes can be switched using the plane control. In true-color composites, the visible spectral channels Red (B04), Green (B03), and Blue (B02) are mapped to the corresponding red, green, and blue color channels, respectively, producing an image of the surface that closely resembles the natural “color” as it would be seen by a human sitting on the spacecraft. False color images are often created using the spectral channels for near-infrared, red, and green. They are particularly useful for assessing vegetation because plants reflect near-infrared and green light while absorbing red light (red-edge effect). Dense vegetation appears a darker red. Cities and open ground appear gray or light brown, water appears blue or black.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#---- Digitization of training data ----</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (digitize) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For the supervised classification, we need training areas. You can digitize them as shown below or alternatively use QGis, for example</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># clearcut</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># For the false color composite r = 8, g = 4, b = 3, maxpixels = 1693870)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># maxpixels has significantly higher memory requirements, vegetation in red</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># below the true color composite</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>train_area_2019 <span class="ot">&lt;-</span> mapview<span class="sc">::</span><span class="fu">viewRGB</span>(pred_stack_2019, <span class="at">r =</span> <span class="dv">4</span>, <span class="at">g =</span> <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">maxpixels =</span> <span class="dv">1693870</span>) <span class="sc">%&gt;%</span> mapedit<span class="sc">::</span><span class="fu">editMap</span>()</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding the attributes class (text) and id/year (integer)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>clearcut_2019 <span class="ot">&lt;-</span> train_area_2019<span class="sc">$</span>finished<span class="sc">$</span>geometry <span class="sc">%&gt;%</span> <span class="fu">st_sf</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">class =</span> <span class="st">"clearcut"</span>, <span class="at">id =</span> <span class="dv">1</span>,<span class="at">year=</span><span class="dv">2019</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>train_area_2020 <span class="ot">&lt;-</span> mapview<span class="sc">::</span><span class="fu">viewRGB</span>(pred_stack_2020, <span class="at">r =</span> <span class="dv">4</span>, <span class="at">g =</span> <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">2</span>,<span class="at">maxpixels =</span> <span class="dv">1693870</span>) <span class="sc">%&gt;%</span> mapedit<span class="sc">::</span><span class="fu">editMap</span>()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>clearcut_2020 <span class="ot">&lt;-</span> train_area_2020<span class="sc">$</span>finished<span class="sc">$</span>geometry <span class="sc">%&gt;%</span> <span class="fu">st_sf</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">class =</span> <span class="st">"clearcut"</span>, <span class="at">id =</span> <span class="dv">1</span>,<span class="at">year=</span><span class="dv">2020</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># other: all areas not belonging to clear cutting as representative as possible</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>train_area_2019 <span class="ot">&lt;-</span> mapview<span class="sc">::</span><span class="fu">viewRGB</span>(pred_stack_2019, <span class="at">r =</span> <span class="dv">4</span>, <span class="at">g =</span> <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> mapedit<span class="sc">::</span><span class="fu">editMap</span>()</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>other_2019 <span class="ot">&lt;-</span> train_area_2019<span class="sc">$</span>finished<span class="sc">$</span>geometry <span class="sc">%&gt;%</span> <span class="fu">st_sf</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">class =</span> <span class="st">"other"</span>, <span class="at">id =</span> <span class="dv">2</span>,<span class="at">year=</span><span class="dv">2019</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>train_area_2020 <span class="ot">&lt;-</span> mapview<span class="sc">::</span><span class="fu">viewRGB</span>(pred_stack_2020, <span class="at">r =</span> <span class="dv">4</span>, <span class="at">g =</span> <span class="dv">3</span>, <span class="at">b =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> mapedit<span class="sc">::</span><span class="fu">editMap</span>()</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>other_2020 <span class="ot">&lt;-</span> train_area_2020<span class="sc">$</span>finished<span class="sc">$</span>geometry <span class="sc">%&gt;%</span> <span class="fu">st_sf</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">class =</span> <span class="st">"other"</span>, <span class="at">id =</span> <span class="dv">2</span>,<span class="at">year=</span><span class="dv">2020</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>train_areas_2019_2020 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(clearcut_2019,clearcut_2020, other_2019,other_2020) <span class="co"># Reproject to the raster file</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>train_areas_2019 <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(train_areas_2019_2020,<span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(pred_stack_2019))</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(<span class="fu">filter</span>(train_areas_2019_2020,year<span class="sc">==</span><span class="dv">2019</span>), <span class="at">zcol=</span><span class="st">"class"</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># save geometries</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(train_areas_2019_2020,<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"train_areas_2019_2020.gpkg"</span>))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the training data for the digitized areas</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>tDF_2019 <span class="ot">=</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(pred_stack_2019, <span class="fu">filter</span>(train_areas_2019_2020,year<span class="sc">==</span><span class="dv">2019</span>), <span class="at">force_df =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="at">include_cell =</span> <span class="cn">TRUE</span>,<span class="at">include_xy =</span> <span class="cn">TRUE</span>,<span class="at">full_colnames =</span> <span class="cn">TRUE</span>,<span class="at">include_cols =</span> <span class="st">"class"</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>tDF_2020 <span class="ot">=</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(pred_stack_2020, <span class="fu">filter</span>(train_areas_2019_2020,year<span class="sc">==</span><span class="dv">2020</span>), <span class="at">force_df =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="at">include_cell =</span> <span class="cn">TRUE</span>,<span class="at">include_xy =</span> <span class="cn">TRUE</span>,<span class="at">full_colnames =</span> <span class="cn">TRUE</span>,<span class="at">include_cols =</span> <span class="st">"class"</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># again, copy together into a file</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>tDF_2019 <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(tDF_2019)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>tDF_2019<span class="sc">$</span>year <span class="ot">=</span> <span class="dv">2019</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>tDF_2020 <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(tDF_2020)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>tDF_2020<span class="sc">$</span>year <span class="ot">=</span> <span class="dv">2020</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete any rows that contain NA (no data) values</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>tDF_2019 <span class="ot">=</span> tDF_2019[<span class="fu">complete.cases</span>(tDF_2019) ,]</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>tDF_2020 <span class="ot">=</span> tDF_2020[<span class="fu">complete.cases</span>(tDF_2020) ,]</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>tDF<span class="ot">=</span> <span class="fu">rbind</span>(tDF_2019,tDF_2020)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co"># check the extracted data</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tDF)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as R internal data format</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="co"># is stored in the repo and can therefore be loaded (line below)</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tDF, <span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"tDF.rds"</span>))</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>tDF <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"tDF.rds"</span>))</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is a table with training data for 2019 and 2020. The data set contains all raster information for all bands covered by the polygons for the classes “clearcut” and “other”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tDF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-3---model-training-testing-model-quality-classification" class="level2">
<h2 class="anchored" data-anchor-id="step-3---model-training-testing-model-quality-classification">Step 3 - Model training, testing model quality, classification</h2>
<p>Classifiers (e.g.&nbsp;the maximum likelihood classifier) or machine learning algorithms (such as Random Forest) use the training data to determine descriptive models that represent statistical signatures, classification trees or other functions. Within the limits of the quality of the training data, such models are suitable and representative for making predictions for areas if the predictors from the model are available for the entire area.</p>
<p>We now want to predict the spatial characteristics of clear-felling/no forest using a maximum likelihood classification and random forest, and apply standard methods of random validation and model quality assessment.</p>
<p>The goal is to separate clearcuts from all other pixels and to quantify the differences between 2019 and 2020.</p>
<section id="maximum-likelihood-classification" class="level3">
<h3 class="anchored" data-anchor-id="maximum-likelihood-classification">Maximum Likelihood Classification</h3>
<p>Maximum likelihood classification assumes that the distribution of data for each class and in each channel is normally distributed. Under this assumption, the probability that a particular pixel belongs to a particular class is calculated. Since the probabilities can also be specified as a threshold, without this restriction, <em>all</em> pixels are assigned regardless of how unlikely they are. Each pixel is assigned to the class that has the highest probability (i.e., the maximum probability).</p>
<p><img src="images/max.png" class="img-fluid"></p>
<p>Since the maximum likelihood algorithm requires training data, it is a supervised learning method. This means that we, as users, have to provide the algorithm with data that conveys knowledge about the classes to be predicted. This data is then divided into training and test data.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Maximum Likelihood Classification ----</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>tDF <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"tDF.rds"</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Here the Random Forest is accessed via the caret utility package</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting a "seed" enables reproducible randomness</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomly draw 15% of the data (training/test)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">=</span> <span class="fu">createDataPartition</span>(tDF<span class="sc">$</span>class,<span class="at">list =</span> <span class="cn">FALSE</span>,<span class="at">p =</span> <span class="fl">0.05</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>trainDat <span class="ot">=</span> tDF[idx,]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>testDat <span class="ot">=</span> tDF[<span class="sc">-</span>idx,]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Response variable (= "class" column) must be of the "factor" data type</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>trainDat<span class="sc">$</span>class <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(trainDat<span class="sc">$</span>class)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>testDat<span class="sc">$</span>class <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(testDat<span class="sc">$</span>class)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># superClass() function from the RSToolbox package requires the table to be converted into the</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># required (old) SpatialdataPoint object</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>sp_trainDat <span class="ot">=</span> trainDat</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>sp_testDat <span class="ot">=</span> testDat </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>sp<span class="sc">::</span><span class="fu">coordinates</span>(sp_trainDat) <span class="ot">=</span> <span class="er">~</span>x<span class="sc">+</span>y</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>sp<span class="sc">::</span><span class="fu">coordinates</span>(sp_testDat) <span class="ot">=</span> <span class="er">~</span>x<span class="sc">+</span>y</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(sp_trainDat) <span class="ot">=</span> <span class="fu">crs</span>(pred_stack_2019)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(sp_testDat) <span class="ot">=</span> <span class="fu">crs</span>(pred_stack_2019)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co"># superClass method "mlc" trains the model and then classifies it</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">#raster::beginCluster(30)</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>prediction_mlc_2019 <span class="ot">&lt;-</span> <span class="fu">superClass</span>(pred_stack_2019, <span class="at">trainData =</span> sp_trainDat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>],<span class="at">valData =</span> sp_testDat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>], <span class="at">responseCol =</span> <span class="st">"class"</span>, <span class="at">model =</span> <span class="st">"mlc"</span>, <span class="at">tuneLength =</span> <span class="dv">1</span>, <span class="at">trainPartition =</span> <span class="fl">0.3</span>,<span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>prediction_mlc_2020 <span class="ot">&lt;-</span> <span class="fu">superClass</span>(pred_stack_2020, <span class="at">trainData =</span> sp_trainDat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>],<span class="at">valData =</span> sp_testDat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>], <span class="at">responseCol =</span> <span class="st">"class"</span>,<span class="at">model =</span> <span class="st">"mlc"</span>, <span class="at">tuneLength =</span> <span class="dv">1</span>, <span class="at">trainPartition =</span> <span class="fl">0.3</span>,<span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(prediction_mlc_2019, <span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_mlc_2019.rds"</span>))</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(prediction_mlc_2020, <span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_mlc_2020.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forest" class="level3">
<h3 class="anchored" data-anchor-id="random-forest">Random forest</h3>
<p>Random forests can be used for both regression and classification tasks, with the latter being particularly relevant in environmental remote sensing. Like any machine learning method, the random forest model learns to recognize patterns and structures in the data itself. Since the random forest algorithm also requires training data, it is also a supervised learning method. <img src="images/Random_forest_diagram_complete.png" class="img-fluid">!</p>
<p>Figure: Simplified illustration of data classification by random forest during training. Venkata Jagannath [CC BY-SA 4.0] via wikipedia.org</p>
<p>A random forest algorithm learns from the data by creating random decision trees – hence the name. For classification tasks, the algorithm takes a suitable instance of a decision tree from the training data set and assigns the corresponding class to the pixel. This is repeated with all available decision trees. Finally, the pixel is assigned to the class that has the most trees, according to the winner-takes-all principle.</p>
</section>
<section id="estimation-model-quality" class="level3">
<h3 class="anchored" data-anchor-id="estimation-model-quality">Estimation model quality</h3>
<p>The test data are now used for the independent quality check of the model. A confusion matrix indicates how accurately the model predicts the correct classes. The main diagonal of the matrix indicates the cases in which the model applies. In our classification of only two classes, however, a special case applies: <a href="https://en.wikipedia.org/wiki/Evaluation_of_binary_classifiers">evaluation of a binary classifier</a>. Detailed explanations for the function used here can be found in the <a href="https://topepo.github.io/caret/measuring-performance.html#measures-for-predicted-classes">caret help</a>.</p>
<p>The main statements about model quality are:</p>
<ul>
<li><em>‘Positive’ Class</em> = <strong>clearcut</strong>: is measured with the sensitivity (<em>true positive rate</em>), which indicates the probability that a positive object is correctly classified as positive.</li>
<li><em>‘Negative Class’</em> = <strong>other</strong>: is measured with the specificity (<em>true negative rate</em>) and indicates the probability that a negative object is correctly classified as negative.</li>
<li><em>Positive and negative predictive values</em> indicate the actual performance for <em>clearcut</em> and <em>other</em>. They are corrected for the actual frequency distribution and are a measure of the precision and performance of the model with regard to the respective classes.</li>
</ul>
<p>Despite the high values, we see that the <em>clearcut</em> class drops off significantly here. This can certainly be taken as an indication of the need to improve the classification.</p>
<p>Overall, however, the model can be considered good.</p>
</section>
<section id="prediction-on-the-original-data" class="level3">
<h3 class="anchored" data-anchor-id="prediction-on-the-original-data">Prediction on the original data</h3>
<p>Now we are ready to apply the verified model to our data set. In remote sensing, this is usually called classification.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Klassifikation (auch Vorhersage genannt)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>prediction_rf_2019  <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">predict</span>(pred_stack_2019 ,rf_model)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>prediction_rf_2020  <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">predict</span>(pred_stack_2020 ,rf_model)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(prediction_rf_2019, <span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_rf_2019.rds"</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(prediction_rf_2020, <span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_rf_2020.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>prediction_rf_2019 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_rf_2019.rds"</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>prediction_rf_2020 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_rf_2020.rds"</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>prediction_mlc_2019 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_mlc_2019.rds"</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>prediction_mlc_2020 <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(envrmt<span class="sc">$</span>path_data,<span class="st">"prediction_mlc_2020.rds"</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- Visualisierung mit mapview ----</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>mapview<span class="sc">::</span><span class="fu">mapshot</span>(mapview<span class="sc">::</span><span class="fu">viewRGB</span>(mask<span class="sc">*</span>pred_stack_2020, <span class="at">r =</span> <span class="dv">4</span>, <span class="at">g =</span><span class="dv">3</span>, <span class="at">b =</span> <span class="dv">2</span>,<span class="at">maxpixels =</span>  <span class="dv">1693870</span>)<span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(mask<span class="sc">*</span>prediction_rf_2019 , <span class="at">alpha.regions =</span> <span class="fl">0.5</span>, <span class="at">maxpixels =</span>  <span class="dv">1693870</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">col.regions =</span> <span class="fu">mapviewPalette</span>(<span class="st">"mapviewRasterColors"</span>),<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, nclasses, <span class="dv">1</span>), <span class="at">legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(mask<span class="sc">*</span>prediction_rf_2020, <span class="at">alpha.regions =</span> <span class="fl">0.5</span>, <span class="at">maxpixels =</span>  <span class="dv">1693870</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">col.regions =</span> <span class="fu">mapviewPalette</span>(<span class="st">"mapviewRasterColors"</span>),<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, nclasses, <span class="dv">1</span>), <span class="at">legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(mask<span class="sc">*</span>prediction_mlc_2019<span class="sc">$</span>map,<span class="at">alpha.regions =</span> <span class="fl">0.5</span>, <span class="at">maxpixels =</span>  <span class="dv">1693870</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">col.regions =</span> <span class="fu">mapviewPalette</span>(<span class="st">"mapviewRasterColors"</span>),<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, nclasses, <span class="dv">1</span>), <span class="at">legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(mask<span class="sc">*</span>prediction_mlc_2020<span class="sc">$</span>map,<span class="at">alpha.regions =</span> <span class="fl">0.5</span>, <span class="at">maxpixels =</span>  <span class="dv">1693870</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">col.regions =</span> <span class="fu">mapviewPalette</span>(<span class="st">"mapviewRasterColors"</span>),<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, nclasses, <span class="dv">1</span>), <span class="at">legend =</span> <span class="cn">FALSE</span>),<span class="at">url =</span> <span class="st">"compare-class.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<iframe valign="center" src="compare-class.html" width="1024" height="960" frameborder="0" allowfullscreen="allowfullscreen">
</iframe>
<figcaption>
<em>Comparison of the two years and RF and MLC classification</em>
</figcaption>
<p>
</p><p>A visual comparison shows that the Random Forest and Maximum Likelihood classifications provide results of comparable quality. But does this impression stand up to quantitative analysis?</p>
</section>
</section>
<section id="further-support" class="level2">
<h2 class="anchored" data-anchor-id="further-support">Further support</h2>
<p>Consider the following resources as examples of how a specific conceptual and technical approach to answering a question can be <em>“crystallized”</em> step by step from the wide range of instructions available on the internet. After a lot of research and critical cross-checking, a <em>“state of research”</em> that is currently considered to be certain within the scientific community can be identified, which can be regarded as a sufficient basis for good scientific practice.</p>
<p>Work/read through the following selection of blogs and guides, even for practice purposes.</p>
<ul>
<li>Robert J. Hijmans <a href="https://rspatial.org/raster/rs/5-supclassification.html">rspatial - supervised classification</a></li>
<li>Ivan Lizarazo <a href="https://rpubs.com/ials2un/rf_landcover">RPubs Tutorial</a></li>
<li>Sydney Goldstein <a href="https://urbanspatial.github.io/classifying_satellite_imagery_in_R/">blog</a></li>
<li>João Gonçalves <a href="https://www.r-exercises.com/2018/03/07/advanced-techniques-with-raster-data-part-2-supervised-classification/">supervised classification</a></li>
<li>Valentin Stefan <a href="https://valentinitnelav.github.io/satellite-image-classification-r/">pixel-based supervised classification</a></li>
</ul>
<p>In the articles, you will always find both technical instructions and conceptual or specific technical questions and solutions. They are by no means a substitute for specialized scientific knowledge. But they show how technical and conceptual understanding can be developed step by step and, by “replicating” and applying, support the skills needed to approach questions independently.</p>
<p>I would like to explicitly quote Valentin Stefan, the author of the blog post <a href="https://valentinitnelav.github.io/satellite-image-classification-r/">pixel-based supervised classification</a>:</p>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><em>“[…] Consider this content a blog post and nothing more. It does not claim to be an exhaustive exercise or a substitute for your critical thinking […].”</em> :::</p>
</div>
</div>
</div>
<p>You can download all the necessary scripts and data from the github repository (https://github.com/gisma/geoinfo/archive/refs/heads/main.zip). Alternatively, you can also set up the repo as a project in Rstudio (Rstudio github (https://www.r-bloggers.com/2015/07/rstudio-and-github/). &gt;</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="gisma-courses/LV-19-d19-006-24" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>LV-19-d19-006-24 (2024)</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/gisma-courses/LV-19-d19-006-24/edit/main/reader/cd-1.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/gisma-courses/LV-19-d19-006-24/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>